<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Trip in Scotland — Yacintha & Loufi</title>
  <meta name="description" content="Fun, colorful mobile travel app — Itinerary, Program, Photos, Notes, Expenses, Checklist." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Pastel 'insta' palette */
      --bg:#0b0f1a;
      --panel:rgba(255,255,255,.10);
      --text:#f9fafb;
      --muted:#cbd5e1;
      --card:#0e1424;
      --border:rgba(255,255,255,.15);
      --grad1:#44e4c9;  /* turquoise */
      --grad2:#9b8bff;  /* violet */
      --grad3:#ff8fb7;  /* coral */
      --grad4:#ffd36e;  /* soft yellow */
      --ok:#28d7a9;
      --warn:#ffd36e;
      --danger:#ff7a9c;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --glass:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1200px 1200px at 100% 0%, #1a1040 0%, transparent 60%),
        radial-gradient(900px 900px at 0% 100%, #10243d 0%, transparent 60%),
        linear-gradient(180deg,#0a0d16,#0b0f1a 60%);
    }
    .container{max-width:960px;margin:0 auto;padding:14px 16px 110px}

    /* Hero */
    .hero{
      position:relative; border-radius:26px; overflow:hidden; padding:18px; margin:8px 0 12px;
      background:linear-gradient(135deg, rgba(68,228,201,.22), rgba(155,139,255,.22), rgba(255,143,183,.22));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      isolation:isolate;
    }
    .hero .cover{
      position:absolute; inset:0; pointer-events:none; opacity:.22;
      background:
        radial-gradient(800px 300px at 90% 10%, #ff9bc4 0%, transparent 60%),
        radial-gradient(600px 300px at 10% 90%, #6be9d3 0%, transparent 60%);
      filter:saturate(120%) blur(0px);
      z-index:-1;
    }
    h1{margin:2px 0 4px; font-size:clamp(20px,5.5vw,28px); letter-spacing:.2px}
    .subtitle{color:var(--muted); font-weight:600; font-size:14px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--glass); padding:8px 12px; border-radius:999px; border:1px solid var(--border);
      backdrop-filter: blur(8px);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{
      background:var(--glass); border:1px solid var(--border); color:var(--text);
      padding:10px 14px; border-radius:14px; cursor:pointer; display:inline-flex; gap:8px; align-items:center;
      min-height:42px; transition:.18s transform, .18s filter;
      backdrop-filter: blur(8px);
    }
    .btn:active{transform:translateY(1px) scale(.98)}
    .btn.primary{
      background:linear-gradient(90deg, var(--grad1), var(--grad2), var(--grad3));
      background-size:200% 100%; color:#0b1020; font-weight:800; border:0;
      animation:flow 8s linear infinite;
    }
    @keyframes flow{0%{background-position:0%}100%{background-position:200%}}

    /* Cards */
    .card{
      background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      margin-top:14px; overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 16px; font-size:17px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border-bottom:1px solid var(--border);
    }
    .card .body{padding:14px 16px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .list{display:grid; gap:10px}
    .item{border:1px solid var(--border); border-radius:16px; padding:12px; background:rgba(255,255,255,.06)}
    .badge{background:rgba(255,255,255,.10); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:#eef2ff; font-weight:700}

    input[type=text], input[type=number], select, textarea{
      width:100%; background:rgba(2,6,23,.7); border:1px solid var(--border); color:var(--text);
      padding:12px; border-radius:14px; font-size:16px; outline:none;
      box-shadow: inset 0 0 0 999px rgba(255,255,255,0); transition: box-shadow .18s;
    }
    input:focus, select:focus, textarea:focus{ box-shadow:0 0 0 2px rgba(155,139,255,.35) }
    textarea{min-height:120px; resize:vertical}

    /* Gallery */
    .drop{border:2px dashed var(--border); border-radius:16px; padding:22px; text-align:center; background:rgba(255,255,255,.06)}
    .gallery{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px}
    .gallery figure{border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#0a0f1e}
    .gallery img{width:100%; height:150px; object-fit:cover; display:block}
    .muted{color:var(--muted)}

    /* Progress */
    .progress{height:10px; background:#0b1222; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg, var(--grad1), var(--grad2), var(--grad3), var(--grad4)); width:0%}

    footer{color:#c8d2ff; font-size:12px; margin-top:14px; opacity:.9}

    /* Bottom Tab Bar (mobile-first) */
    .tabs{
      position:fixed; left:0; right:0; bottom:0; padding:10px 12px; z-index:50;
      display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory;
      background:linear-gradient(180deg, rgba(12,18,36,.85), rgba(9,12,24,.95)); backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
    }
    .tab{
      flex:0 0 auto; scroll-snap-align:start;
      display:flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.08); color:#eef2ff; font-weight:800; letter-spacing:.2px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); font-size:14px;
    }
    .tab .ico{font-size:18px}
    .tab.active{color:#0b1020; border:0; background:linear-gradient(90deg, var(--grad1), var(--grad2), var(--grad3));}

    /* Desktop: grid tabs on top & less bottom space */
    @media(min-width:960px){
      .container{padding-bottom:24px}
      .tabs{position:static; border-radius:18px; border:1px solid var(--border); background:var(--glass); gap:0; overflow:visible; display:grid; grid-template-columns:repeat(6,1fr); padding:0; margin-top:10px}
      .tab{border-radius:0; min-width:auto; justify-content:center; border-right:1px solid var(--border); box-shadow:none}
      .tab:last-child{border-right:none}
    }
    .content{padding-bottom:110px}
    .fade-in{animation:fade .35s ease}
    @keyframes fade{from{opacity:.0; transform:translateY(4px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Hero -->
    <section class="hero fade-in">
      <div class="cover"></div>
      <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px;">
        <div>
          <h1>Trip in Scotland — Yacintha & Loufi 🏴</h1>
          <div class="subtitle">21/09 → 26/09 · Edinburgh & Skye</div>
          <div class="row actions" style="margin-top:10px">
            <span class="chip">✈️ Arrival 21/09</span>
            <span class="chip">🚐 Campervan</span>
            <span class="chip">🏞️ Skye</span>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="exportBtn">💾 Export</button>
          <button class="btn" id="importBtn">📥 Import</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>
      </div>
    </section>

    <!-- Content -->
    <section class="content">
      <!-- Itinerary -->
      <div id="itinerary" class="card fade-in">
        <h2>
          <span>🗺️ Itinerary (editable)</span>
          <span class="row" style="width:100%; max-width:680px">
            <input type="text" id="newDayDate" placeholder="Date (e.g. 21/09)" style="max-width:120px" />
            <input type="text" id="newDayTitle" placeholder="Title" style="flex:1;min-width:140px" />
            <input type="text" id="newDayDetails" placeholder="Details (optional)" style="flex:1;min-width:180px" />
            <button class="btn primary" id="addDayBtn">＋ Add day</button>
          </span>
        </h2>
        <div class="body">
          <div class="list" id="itineraryList"></div>
          <div class="muted" style="margin-top:6px">Tip: use “↑/↓” to reorder quickly.</div>
        </div>
      </div>

      <!-- Program -->
      <div id="program" class="card fade-in" style="display:none">
        <h2>
          <span>🎯 Program — Suggestions (Edinburgh)</span>
          <span class="row" style="width:100%">
            <select id="programDaySelect" style="flex:1;min-width:140px"></select>
            <select id="programPick" style="flex:2;min-width:200px"><option value="">— Choose —</option></select>
            <button class="btn primary" id="programAdd">Add</button>
          </span>
        </h2>
        <div class="body">
          <p class="muted" style="margin-top:0">Pick a day, then a suggestion — it gets appended to that day's details.</p>
          <div id="programSuggestions" class="row" style="flex-wrap:wrap"></div>
        </div>
      </div>

      <!-- Gallery -->
      <div id="gallery" class="card fade-in" style="display:none">
        <h2>
          <span>📷 Photos</span>
          <span class="row">
            <button class="btn primary" id="addPhotosBtn">＋ Add</button>
            <input type="file" id="photosInput" accept="image/*" multiple style="display:none" />
          </span>
        </h2>
        <div class="body">
          <div class="drop" id="dropZone">Tap “Add” (or drag & drop on desktop).</div>
          <div id="galleryGrid" class="gallery" style="margin-top:10px"></div>
          <p id="galleryEmpty" class="muted" style="text-align:center;display:none">No photos yet.</p>
        </div>
      </div>

      <!-- Notes -->
      <div id="notes" class="card fade-in" style="display:none">
        <h2>
          <span>📝 Notes</span>
          <span class="row muted" style="font-size:12px">Auto timestamp <input type="checkbox" id="autoDate" checked /></span>
        </h2>
        <div class="body">
          <div class="row" style="margin-bottom:8px; gap:8px">
            <button class="btn">🍺</button>
            <button class="btn">🥧</button>
            <button class="btn">🏰</button>
            <button class="btn">🎶</button>
            <button class="btn">🌊</button>
            <button class="btn">🚐</button>
            <button class="btn">☔️</button>
          </div>
          <textarea id="notesArea" placeholder="Your notes, addresses, times, memories…"></textarea>
        </div>
      </div>

      <!-- Expenses -->
      <div id="expenses" class="card fade-in" style="display:none">
        <h2>
          <span>💷 Expenses</span>
          <span class="row" style="width:100%">
            <select id="payer" style="flex:1;min-width:110px">
              <option value="Yacintha">Yacintha</option>
              <option value="Loufi">Loufi</option>
            </select>
            <input type="text" id="expenseWhat" placeholder="What" style="flex:2" />
            <input type="number" id="expenseAmt" placeholder="Amount" step="0.01" style="width:120px" />
            <select id="expenseCat" style="flex:1;min-width:130px">
              <option>Food</option><option>Transport</option><option>Accommodation</option>
              <option>Attractions</option><option>Fuel</option><option>Other</option>
            </select>
            <input type="text" id="expenseCur" value="GBP" style="width:90px" />
            <button class="btn primary" id="expenseAdd">Add</button>
          </span>
        </h2>
        <div class="body">
          <div style="overflow:auto">
            <table style="width:100%;border-collapse:collapse;min-width:620px">
              <thead>
                <tr style="color:#e9edff;font-size:14px">
                  <th style="padding:8px;border-bottom:1px solid var(--border); text-align:left">Date</th>
                  <th style="padding:8px;border-bottom:1px solid var(--border); text-align:left">Payer</th>
                  <th style="padding:8px;border-bottom:1px solid var(--border); text-align:left">What</th>
                  <th style="padding:8px;border-bottom:1px solid var(--border); text-align:left">Cat.</th>
                  <th style="padding:8px;border-bottom:1px solid var(--border); text-align:left">Amount</th>
                  <th style="padding:8px;border-bottom:1px solid var(--border)"></th>
                </tr>
              </thead>
              <tbody id="expenseTbody" style="font-size:15px"></tbody>
            </table>
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;font-size:15px">
            <div class="chip">Total Y: <strong id="totY" style="margin-left:6px">0</strong></div>
            <div class="chip">Total L: <strong id="totL" style="margin-left:6px">0</strong></div>
            <div class="chip">Total: <strong id="totAll" style="margin-left:6px">0</strong> <span id="totCur" style="margin-left:4px"></span></div>
            <div class="chip" style="background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08))">Settlement: <strong id="settlement" style="margin-left:6px">—</strong></div>
          </div>
          <p class="muted" style="margin-top:8px">Assumes a 50/50 split. If one paid more than half, the other owes the difference.</p>
        </div>
      </div>

      <!-- Checklist -->
      <div id="checklist" class="card fade-in" style="display:none">
        <h2><span>✅ Checklist</span><span class="badge" id="progressBadge">Progress: 0%</span></h2>
        <div class="body">
          <div class="progress"><div id="progressBar"></div></div>
          <div class="row" style="margin-top:10px;margin-bottom:10px">
            <input type="text" id="taskInput" placeholder="Add an item" />
            <button class="btn primary" id="taskAdd">Add</button>
          </div>
          <div id="taskList" class="list"></div>
        </div>
      </div>

      <footer>💡 Everything is stored locally in your browser. Use <strong>Export</strong>/<strong>Import</strong> to back up or share across devices.</footer>
    </section>
  </div>

  <!-- Bottom Tab Bar -->
  <nav class="tabs" id="tabs">
    <button class="tab active" data-tab="itinerary"><span class="ico">🗺️</span>Itinerary</button>
    <button class="tab" data-tab="program"><span class="ico">🎯</span>Program</button>
    <button class="tab" data-tab="gallery"><span class="ico">📷</span>Photos</button>
    <button class="tab" data-tab="notes"><span class="ico">📝</span>Notes</button>
    <button class="tab" data-tab="expenses"><span class="ico">💷</span>Expenses</button>
    <button class="tab" data-tab="checklist"><span class="ico">✅</span>Checklist</button>
  </nav>

  <script>
    const STORAGE_KEY = "trip-scotland-yl-insta-en-v1";
    const defaultData = {
      dates:"21/09 → 26/09",
      itinerary:[
        {date:"21/09", title:"Arrival — Hotel — Rest", details:"Arrive in Edinburgh, check in, easy evening."},
        {date:"22/09", title:"Edinburgh visit", details:"Old Town, Royal Mile, Edinburgh Castle, Dean Village."},
        {date:"23/09", title:"Campervan pick up", details:"Pick up van, groceries, scenic start."},
        {date:"24/09", title:"Isle of Skye", details:"Fairy Pools, Old Man of Storr, Quiraing."},
        {date:"25/09", title:"Return to Edinburgh — Rest", details:"Return van, hotel, Calton Hill sunset."},
        {date:"26/09", title:"Return to Brussels", details:"Airport transfer, flight home."}
      ],
      programSuggestions:[
        "Edinburgh Castle (guided)",
        "Arthur's Seat (morning, epic view)",
        "Dean Village + Water of Leith",
        "National Museum of Scotland (free)",
        "Scottish National Gallery (free)",
        "Old Town ghost tour (evening)",
        "Calton Hill sunset",
        "Princes Street Gardens picnic",
        "Haggis tasting (traditional pub)",
        "Camera Obscura & Illusions",
        "Brunch in Stockbridge",
        "Live folk music (pub night)",
        "Newhaven harbour walk (fish & chips)"
      ],
      notes:"",
      gallery:[],
      expenses:{currency:"GBP", items:[]},
      checklist:[
        {id:"id",text:"Passport / ID",done:false},
        {id:"tickets",text:"Flight tickets / QR codes",done:false},
        {id:"cards",text:"Bank cards + cash",done:false},
        {id:"rainjacket",text:"Rain jacket",done:false},
        {id:"shoes",text:"Walking shoes",done:false},
        {id:"sleepbag",text:"Sleeping bags (van)",done:false},
        {id:"toothbrush",text:"Toothbrushes",done:false},
        {id:"toothpaste",text:"Toothpaste",done:false},
        {id:"adapter",text:"UK plug adapter (Type G)",done:false},
        {id:"chargers",text:"Chargers & powerbank",done:false},
        {id:"meds",text:"Meds kit (ibuprofen, plasters)",done:false}
      ]
    };

    function loadState(){ try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):defaultData; }catch(e){return defaultData;} }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    let state = loadState();
    // Tabs
    const tabs = document.querySelectorAll(".tab");
    function showTab(name){
      tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===name));
      document.querySelectorAll(".card").forEach(c=>c.style.display="none");
      const el = document.getElementById(name);
      if(el){ el.style.display=""; el.classList.add("fade-in"); }
      window.scrollTo({top:0, behavior:"smooth"});
    }
    tabs.forEach(t=> t.addEventListener("click", ()=> showTab(t.dataset.tab)));

    // Itinerary render
    const itineraryList = document.getElementById("itineraryList");
    function renderItinerary(){
      itineraryList.innerHTML = "";
      state.itinerary.forEach((it, idx)=>{
        const wrap = document.createElement("div");
        wrap.className = "item";
        wrap.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <div class="row">
              <span class="badge">${escapeHtml(it.date)}</span>
              <input type="text" value="${escapeHtml(it.title)}" data-k="title" style="min-width:220px" />
            </div>
            <div class="row">
              <button class="btn" data-action="up" title="Move up">⬆️</button>
              <button class="btn" data-action="down" title="Move down">⬇️</button>
              <button class="btn" data-action="del" title="Delete">🗑️</button>
            </div>
          </div>
          <textarea data-k="details" placeholder="Details…">${escapeHtml(it.details||"")}</textarea>
        `;
        wrap.querySelector('[data-action="up"]').onclick = ()=>{ if(idx>0){ const a=state.itinerary[idx-1]; state.itinerary[idx-1]=state.itinerary[idx]; state.itinerary[idx]=a; saveState(); renderItinerary(); bootProgram(); } };
        wrap.querySelector('[data-action="down"]').onclick = ()=>{ if(idx<state.itinerary.length-1){ const a=state.itinerary[idx+1]; state.itinerary[idx+1]=state.itinerary[idx]; state.itinerary[idx]=a; saveState(); renderItinerary(); bootProgram(); } };
        wrap.querySelector('[data-action="del"]').onclick = ()=>{ state.itinerary.splice(idx,1); saveState(); renderItinerary(); bootProgram(); };
        wrap.querySelectorAll("input,textarea").forEach(field=>{
          field.addEventListener("input", ()=>{
            const k = field.dataset.k; state.itinerary[idx][k] = field.value; saveState(); bootProgram();
          });
        });
        itineraryList.appendChild(wrap);
      });
    }
    document.getElementById("addDayBtn").onclick = ()=>{
      const d = document.getElementById("newDayDate").value.trim();
      const title = document.getElementById("newDayTitle").value.trim();
      const details = document.getElementById("newDayDetails").value.trim();
      if(!d||!title) return;
      state.itinerary.push({date:d,title,details});
      document.getElementById("newDayDate").value="";
      document.getElementById("newDayTitle").value="";
      document.getElementById("newDayDetails").value="";
      saveState(); renderItinerary(); bootProgram();
    };

    // Program suggestions
    function chip(text){
      const b=document.createElement("button");
      b.className="chip"; b.style.cursor="pointer";
      b.textContent="＋ "+text;
      b.onclick=()=>{
        const idx=parseInt(document.getElementById("programDaySelect").value||"0",10);
        if(state.itinerary[idx]){
          state.itinerary[idx].details=(state.itinerary[idx].details?state.itinerary[idx].details+"\\n":"")+"• "+text;
          saveState(); renderItinerary();
        }
      };
      return b;
    }
    function bootProgram(){
      const sel = document.getElementById("programDaySelect");
      sel.innerHTML = "";
      state.itinerary.forEach((it, idx)=>{ const o=document.createElement("option"); o.value=idx; o.textContent=(it.date?it.date+" — ":"")+it.title; sel.appendChild(o); });
      const pick = document.getElementById("programPick"); pick.innerHTML = '<option value="">— Choose —</option>';
      state.programSuggestions.forEach((s,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=s; pick.appendChild(o); });
      const area = document.getElementById("programSuggestions");
      area.innerHTML = "";
      state.programSuggestions.forEach(s=> area.appendChild(chip(s)));
    }
    document.getElementById("programAdd").onclick = ()=>{
      const pick = document.getElementById("programPick");
      const sel = document.getElementById("programDaySelect");
      const i=parseInt(pick.value||"-1",10);
      const d=parseInt(sel.value||"0",10);
      if(i>=0 && state.itinerary[d]){
        const s = state.programSuggestions[i];
        state.itinerary[d].details=(state.itinerary[d].details?state.itinerary[d].details+"\\n":"")+"• "+s;
        saveState(); renderItinerary();
      }
    };

    // Gallery
    const galleryGrid = document.getElementById("galleryGrid");
    const galleryEmpty = document.getElementById("galleryEmpty");
    const dropZone = document.getElementById("dropZone");
    function renderGallery(){
      galleryGrid.innerHTML = "";
      galleryEmpty.style.display = state.gallery.length ? "none":"block";
      state.gallery.forEach(item=>{
        const fig = document.createElement("figure");
        fig.innerHTML = `
          <img src="${item.src}" alt="photo" />
          <figcaption style="padding:10px;border-top:1px solid var(--border)">
            <input type="text" value="${escapeHtml(item.caption||'')}" placeholder="Caption…" data-id="${item.id}" class="caption"/>
            <div class="row" style="margin-top:6px;justify-content:space-between;font-size:12px;color:var(--muted)">
              <span>${item.date}</span>
              <button class="btn" data-del="${item.id}">🗑️</button>
            </div>
          </figcaption>`;
        fig.querySelector('[data-del]').onclick = ()=>{
          state.gallery = state.gallery.filter(g=>g.id !== item.id);
          saveState(); renderGallery();
        };
        fig.querySelector('.caption').oninput = (e)=>{
          const g = state.gallery.find(x=>x.id===item.id);
          g.caption = e.target.value; saveState();
        };
        galleryGrid.appendChild(fig);
      });
    }
    function handleFiles(files){
      const arr = Array.from(files).slice(0,60);
      (async ()=>{
        for(const f of arr){
          if(!f.type.startsWith("image/")) continue;
          const src = await compressImage(f,1600,1600,0.86);
          state.gallery.push({ id:crypto.randomUUID(), src, caption:"", date:new Date().toLocaleDateString() });
        }
        saveState(); renderGallery();
      })();
    }
    document.getElementById("addPhotosBtn").onclick = ()=> document.getElementById("photosInput").click();
    document.getElementById("photosInput").addEventListener("change",(e)=> handleFiles(e.target.files));
    ["dragover","dragenter"].forEach(ev=> dropZone.addEventListener(ev,(e)=>{ e.preventDefault(); dropZone.style.background="rgba(255,255,255,.10)"; }));
    ["dragleave","drop"].forEach(ev=> dropZone.addEventListener(ev,(e)=>{ e.preventDefault(); dropZone.style.background="rgba(255,255,255,.06)"; }));
    dropZone.addEventListener("drop",(e)=> handleFiles(e.dataTransfer.files));
    function compressImage(file, maxW, maxH, quality=0.85){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = ()=>{ img.src = reader.result; };
        reader.onerror = reject;
        img.onload = ()=>{
          const ratio = Math.min(maxW/img.width, maxH/img.height, 1);
          const canvas = document.createElement("canvas");
          canvas.width = Math.round(img.width*ratio);
          canvas.height = Math.round(img.height*ratio);
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          try{ resolve(canvas.toDataURL("image/jpeg", quality)); }catch(e){ reject(e); }
        };
        img.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Notes
    const notesArea = document.getElementById("notesArea");
    const autoDate = document.getElementById("autoDate");
    notesArea.value = state.notes || "";
    document.querySelectorAll('#notes .btn').forEach(btn=>{
      btn.addEventListener("click",()=>{
        const stamp = btn.textContent.trim();
        const prefix = autoDate.checked ? "\\n["+new Date().toLocaleString()+"] " : "\\n";
        notesArea.value += prefix + stamp + " ";
        state.notes = notesArea.value; saveState();
      });
    });
    notesArea.addEventListener("input",()=>{ state.notes = notesArea.value; saveState(); });

    // Expenses
    function renderExpenses(){
      const tbody=document.getElementById("expenseTbody");
      tbody.innerHTML="";
      let y=0,l=0,cur=state.expenses.currency||"GBP";
      state.expenses.items.forEach((ex,idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(ex.date||"")}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(ex.who)}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(ex.what)}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(ex.cat)}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${Number(ex.amt).toFixed(2)} ${cur}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)"><button class="btn" data-del="${idx}">🗑️</button></td>`;
        tr.querySelector('[data-del]').onclick=()=>{ state.expenses.items.splice(idx,1); saveState(); renderExpenses(); };
        tbody.appendChild(tr);
        if(ex.who==="Yacintha") y+=Number(ex.amt)||0; else l+=Number(ex.amt)||0;
      });
      const all=y+l;
      document.getElementById("totY").textContent = y.toFixed(2)+" "+cur;
      document.getElementById("totL").textContent = l.toFixed(2)+" "+cur;
      document.getElementById("totAll").textContent = all.toFixed(2);
      document.getElementById("totCur").textContent = cur;
      const half=all/2;
      let text="—";
      if(all>0){
        if(y>half) text="Loufi owes "+(y-half).toFixed(2)+" "+cur+" to Yacintha";
        else if(l>half) text="Yacintha owes "+(l-half).toFixed(2)+" "+cur+" to Loufi";
        else text="Balanced";
      }
      document.getElementById("settlement").textContent = text;
    }
    document.getElementById("expenseAdd").onclick = ()=>{
      const who=document.getElementById("payer").value;
      const what=document.getElementById("expenseWhat").value.trim();
      const amt=parseFloat(document.getElementById("expenseAmt").value);
      const cat=document.getElementById("expenseCat").value;
      const cur=document.getElementById("expenseCur").value.trim()||"GBP";
      if(!what||isNaN(amt)) return;
      state.expenses.currency=cur;
      state.expenses.items.push({date:new Date().toLocaleDateString(), who, what, cat, amt});
      document.getElementById("expenseWhat").value="";
      document.getElementById("expenseAmt").value="";
      saveState(); renderExpenses();
    };

    // Checklist
    const taskList = document.getElementById("taskList");
    function renderChecklist(){
      taskList.innerHTML="";
      let done=0,total=state.checklist.length||1;
      state.checklist.forEach(i=>{ if(i.done) done++; });
      const pct=Math.round(done/total*100);
      document.getElementById("progressBadge").textContent="Progress: "+pct+"%";
      document.getElementById("progressBar").style.width=pct+"%";
      state.checklist.forEach(item=>{
        const div=document.createElement("div");
        div.className="item row";
        div.style.justifyContent="space-between";
        div.innerHTML = `<label class="row" style="gap:10px">
            <input type="checkbox" ${item.done?"checked":""} data-id="${item.id}" />
            <span style="${item.done?'text-decoration:line-through;color:var(--muted)':''}">${escapeHtml(item.text)}</span>
          </label>
          <button class="btn" data-del="${item.id}">🗑️</button>`;
        div.querySelector('[data-id]').onchange=(e)=>{
          const id=e.target.getAttribute('data-id');
          const el=state.checklist.find(c=>c.id===id);
          el.done=!el.done; saveState(); renderChecklist();
        };
        div.querySelector('[data-del]').onclick=()=>{
          const id=div.querySelector('[data-del]').getAttribute('data-del');
          state.checklist=state.checklist.filter(c=>c.id!==id);
          saveState(); renderChecklist();
        };
        taskList.appendChild(div);
      });
    }
    document.getElementById("taskAdd").onclick = ()=>{
      const val=document.getElementById("taskInput").value.trim();
      if(!val) return;
      state.checklist.push({id:crypto.randomUUID(), text:val, done:false});
      document.getElementById("taskInput").value="";
      saveState(); renderChecklist();
    };

    // Export / Import
    document.getElementById("exportBtn").onclick = ()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="trip-scotland-yacintha-loufi.json"; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById("importBtn").onclick = ()=> document.getElementById("fileInput").click();
    document.getElementById("fileInput").addEventListener("change",(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{ state = {...state, ...JSON.parse(reader.result)}; saveState(); boot(); }
        catch(err){ alert("Invalid file"); }
      };
      reader.readAsText(f);
    });

    function boot(){
      renderItinerary();
      bootProgram();
      renderGallery();
      renderExpenses();
      renderChecklist();
      showTab("itinerary");
    }
    boot();
  </script>
</body>
</html>
